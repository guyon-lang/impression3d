<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion Impressions 3D</title>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { margin-top: 0; }
form input, form select, form textarea, form button { display: block; margin-bottom: 10px; width: 300px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
#calendar { margin-top: 30px; height: 650px; }
.hidden { display: none; }
button { cursor: pointer; }
#confirmation { color: green; display: none; margin-top: 10px; }
.date-fr { font-weight: bold; color: #333; margin-left: 5px; }
</style>
</head>

<body>

<h1>Gestion Impressions 3D – Bambu Lab H2D</h1>

<!-- DEMANDEUR -->
<div id="demandeur">
<h2>Nouvelle demande d'impression</h2>

<form id="formDemande">
  <input required placeholder="Nom" id="nom">
  <input required placeholder="Lien ou fichier STL" id="fichier">
  
  <select id="priorite">
    <option>Basse</option>
    <option selected>Normale</option>
    <option>Haute</option>
  </select>

  <input type="date" id="dateSouhaitee">
  <textarea placeholder="Commentaires (optionnel)" id="commentaires"></textarea>

  <button type="submit">Envoyer la demande</button>
</form>

<p id="confirmation">✅ Votre demande a bien été envoyée.</p>
</div>

<!-- GESTIONNAIRE -->
<div id="gestionnaire" class="hidden">
<h2>Gestionnaire</h2>

<table>
<thead>
<tr>
<th>Nom</th>
<th>Fichier</th>
<th>Priorité</th>
<th>Date souhaitée</th>
<th>Date réelle</th>
<th>Statut</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableDemandes"></tbody>
</table>

<div id="calendar"></div>
</div>

<!-- FullCalendar JS via module ES -->
<script type="module">
import { Calendar } from 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.esm.js';
import frLocale from 'https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/fr.js';

document.addEventListener("DOMContentLoaded", function() {

  let demandes = JSON.parse(localStorage.getItem("demandes") || "[]");
  let calendar;

  // ---------------------- Fonctions de conversion ----------------------
  function formatDateFR(isoDate) {
    if(!isoDate) return "";
    const d = new Date(isoDate);
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth()+1).padStart(2,'0');
    const year = d.getFullYear();
    return `${day}-${month}-${year}`;
  }

  // ---------------------- Routage Hash ----------------------
  function updateView() {
    if(location.hash === "#/gestionnaire") {
      document.getElementById("demandeur").classList.add("hidden");
      document.getElementById("gestionnaire").classList.remove("hidden");
      renderCalendar(); // rendre après affichage
    } else {
      document.getElementById("demandeur").classList.remove("hidden");
      document.getElementById("gestionnaire").classList.add("hidden");
    }
  }

  window.addEventListener("hashchange", updateView);

  // Forcer un hash par défaut si vide
  if(!window.location.hash || window.location.hash === "#/") {
    window.location.hash = "#/demandeur";
  }

  // Petit délai pour s'assurer que le hash initial est lu
  setTimeout(updateView, 10);

  // ---------------------- Formulaire ----------------------
  document.getElementById("formDemande").onsubmit = function(e) {
    e.preventDefault();

    demandes.push({
      id: Date.now(),
      nom: document.getElementById("nom").value,
      fichier: document.getElementById("fichier").value,
      priorite: document.getElementById("priorite").value,
      dateSouhaitee: document.getElementById("dateSouhaitee").value,
      dateReelle: "",
      statut: "En attente"
    });

    save();
    e.target.reset();

    const conf = document.getElementById("confirmation");
    conf.style.display = "block";
    setTimeout(() => { conf.style.display = "none"; }, 3000);
  };

  // ---------------------- Tableau ----------------------
  function renderTable() {
    const tableBody = document.getElementById("tableDemandes");
    tableBody.innerHTML = "";

    demandes.forEach(d => {
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.nom}</td>
        <td><a href="${d.fichier}" target="_blank">Lien</a></td>
        <td>${d.priorite}</td>
        <td>${d.dateSouhaitee || ""}</td>
        <td>
          <input type="date" value="${d.dateReelle || ""}" onchange="setDate(${d.id}, this.value)">
          <span class="date-fr">${formatDateFR(d.dateReelle)}</span>
        </td>
        <td>${d.statut}</td>
        <td>
          <button onclick="setStatut(${d.id}, 'Validée')">Valider</button>
          <button onclick="setStatut(${d.id}, 'Refusée')">Refuser</button>
          <button onclick="supprimer(${d.id})">Supprimer</button>
        </td>`;
      tableBody.appendChild(tr);
    });
  }

  // ---------------------- Gestion Statut / Date / Supprimer ----------------------
  window.setStatut = function(id, statut) {
    let demande = demandes.find(d => d.id === id);
    if(demande) { demande.statut = statut; save(); }
  }

  window.setDate = function(id, date) {
    let demande = demandes.find(d => d.id === id);
    if(demande) { 
      let d = new Date(date);
      demande.dateReelle = d.toISOString().slice(0,10);
      save(); 
    }
  }

  window.supprimer = function(id) {
    if(confirm("Supprimer cette demande ?")) {
      demandes = demandes.filter(d => d.id !== id);
      save();
    }
  }

  // ---------------------- Calendrier ----------------------
  function renderCalendar() {
    const calendarEl = document.getElementById("calendar");
    if(!calendarEl) return;

    if(calendar) calendar.destroy();

    calendar = new Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: frLocale,
      events: demandes
        .filter(d => d.statut === "Validée" && d.dateReelle)
        .map(d => ({
          title: `${d.nom} (${d.priorite})`,
          start: d.dateReelle,
          backgroundColor:
            d.priorite==="Haute"?"#ff6666":d.priorite==="Basse"?"#93c47d":"#ffd966"
        }))
    });

    calendar.render();
  }

  // ---------------------- Sauvegarde ----------------------
  function save() {
    localStorage.setItem("demandes", JSON.stringify(demandes));
    renderTable();
    if(location.hash === "#/gestionnaire") renderCalendar();
  }

  // ---------------------- Initialisation ----------------------
  renderTable();

});
</script>

</body>
</html>
