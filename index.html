  <!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion Impressions 3D</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">

<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { margin-top: 0; }
form input, form select, form textarea, form button { display: block; margin-bottom: 10px; width: 300px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
#calendar { margin-top: 30px; height: 650px; }
.hidden { display: none; }
button { cursor: pointer; }
#confirmation { color: green; display: none; margin-top: 10px; }
</style>
</head>

<body>

<h1>Gestion Impressions 3D – Bambu Lab H2D</h1>

<!-- DEMANDEUR -->
<div id="demandeur">
<h2>Nouvelle demande d'impression</h2>
<form id="formDemande">
  <input required placeholder="Nom" id="nom">
  <input required placeholder="Lien ou fichier STL" id="fichier">
  <select id="priorite">
    <option>Basse</option>
    <option selected>Normale</option>
    <option>Haute</option>
  </select>
  <input type="date" id="dateSouhaitee">
  <textarea placeholder="Commentaires (optionnel)" id="commentaires"></textarea>
  <button type="submit">Envoyer la demande</button>
</form>
<p id="confirmation">✅ Votre demande a bien été envoyée.</p>
</div>

<!-- GESTIONNAIRE -->
<div id="gestionnaire" class="hidden">
<h2>Gestionnaire</h2>
<table>
<thead>
<tr>
<th>Nom</th>
<th>Fichier</th>
<th>Priorité</th>
<th>Date souhaitée</th>
<th>Date réelle</th>
<th>Statut</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="tableDemandes"></tbody>
</table>
<div id="calendar"></div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/fr.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  let demandes = JSON.parse(localStorage.getItem("demandes") || "[]");
  let calendar;

  // ROUTAGE HASH
  function updateView() {
    if(location.hash === "#/gestionnaire") {
      document.getElementById("demandeur").classList.add("hidden");
      document.getElementById("gestionnaire").classList.remove("hidden");
    } else {
      document.getElementById("demandeur").classList.remove("hidden");
      document.getElementById("gestionnaire").classList.add("hidden");
    }
  }
  window.addEventListener("hashchange", updateView);
  updateView();

  // FORMULAIRE
  document.getElementById("formDemande").onsubmit = function(e) {
    e.preventDefault();
    const nomVal = document.getElementById("nom").value;
    const fichierVal = document.getElementById("fichier").value;
    const prioriteVal = document.getElementById("priorite").value;
    const dateSouhaiteeVal = document.getElementById("dateSouhaitee").value;

    demandes.push({
      id: Date.now(),
      nom: nomVal,
      fichier: fichierVal,
      priorite: prioriteVal,
      dateSouhaitee: dateSouhaiteeVal,
      dateReelle: "",
      statut: "En attente"
    });

    save();
    e.target.reset();
    const conf = document.getElementById("confirmation");
    conf.style.display = "block";
    setTimeout(()=>{ conf.style.display="none"; },3000);
  };

  // TABLEAU
  function renderTable() {
    const tbody = document.getElementById("tableDemandes");
    tbody.innerHTML = "";
    demandes.forEach(d=>{
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.nom}</td>
        <td><a href="${d.fichier}" target="_blank">Lien</a></td>
        <td>${d.priorite}</td>
        <td>${d.dateSouhaitee||""}</td>
        <td><input type="date" value="${d.dateReelle||""}" onchange="setDate(${d.id},this.value)"></td>
        <td>${d.statut}</td>
        <td>
          <button onclick="setStatut(${d.id},'Validée')">Valider</button>
          <button onclick="setStatut(${d.id},'Refusée')">Refuser</button>
          <button onclick="supprimer(${d.id})">Supprimer</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  window.setStatut = function(id,s){ let d=demandes.find(x=>x.id===id); if(d){d.statut=s;save();} }
  window.setDate = function(id,date){ let d=demandes.find(x=>x.id===id); if(d){d.dateReelle=date;save();} }
  window.supprimer = function(id){ if(confirm("Supprimer cette demande ?")){demandes=demandes.filter(d=>d.id!==id);save();} }

  // CALENDRIER
  function renderCalendar() {
    const el=document.getElementById("calendar");
    if(!el) return;
    if(calendar) calendar.destroy();
    calendar = new FullCalendar.Calendar(el,{
      initialView:'dayGridMonth',
      locale:'fr',
      events:demandes.filter(d=>d.statut==='Validée'&&d.dateReelle).map(d=>({
        title:`${d.nom} (${d.priorite})`,
        start:d.dateReelle,
        backgroundColor: d.priorite==='Haute'?'#ff6666': d.priorite==='Basse'?'#93c47d':'#ffd966'
      }))
    });
    calendar.render();
  }

  // SAUVEGARDE
  function save(){ localStorage.setItem("demandes",JSON.stringify(demandes)); renderTable(); renderCalendar(); }

  // INITIALISATION
  renderTable(); renderCalendar();
});
</script>

</body>
</html>
